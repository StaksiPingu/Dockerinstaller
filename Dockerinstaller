#!/bin/bash

# Farben für bessere Lesbarkeit
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
clear
echo -e "${BLUE}"
echo "╔══════════════════════════════════════════════════════════╗"
echo "║     Docker & Portainer Installation Script              ║"
echo "║     für Ubuntu 24.04 LTS                                 ║"
echo "║     Docker 29 kompatibel                                 ║"
echo "╚══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

# Funktion: Docker 28.x installieren (stabil mit Portainer)
install_docker_28() {
    echo -e "${GREEN}[INFO] Installiere Docker 28.x (stabile Version für Portainer)...${NC}"
    
    # Alte Versionen entfernen
    apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null
    
    # Abhängigkeiten installieren
    apt-get update
    apt-get install -y \
        ca-certificates \
        curl \
        gnupg \
        lsb-release
    
    # Docker GPG Key hinzufügen
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
    
    # Docker Repository hinzufügen
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # Docker 28.5.2 installieren (letzte stabile Version vor 29)
    apt-get update
    apt-get install -y \
        docker-ce=5:28.5.2-1~ubuntu.24.04~noble \
        docker-ce-cli=5:28.5.2-1~ubuntu.24.04~noble \
        containerd.io \
        docker-buildx-plugin \
        docker-compose-plugin
    
    # Versionen auf hold setzen (verhindert automatisches Update auf v29)
    apt-mark hold docker-ce docker-ce-cli
    
    # Docker Dienst starten
    systemctl start docker
    systemctl enable docker
    
    echo -e "${GREEN}[SUCCESS] Docker 28.5.2 erfolgreich installiert und auf hold gesetzt!${NC}"
    echo -e "${YELLOW}[INFO] Docker wird NICHT automatisch auf v29 aktualisiert${NC}"
    docker --version
}

# Funktion: Docker 29.x installieren mit API-Workaround
install_docker_29() {
    echo -e "${GREEN}[INFO] Installiere Docker 29.x mit Portainer-Kompatibilität...${NC}"
    
    # Alte Versionen entfernen
    apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null
    
    # Abhängigkeiten installieren
    apt-get update
    apt-get install -y \
        ca-certificates \
        curl \
        gnupg \
        lsb-release
    
    # Docker GPG Key hinzufügen
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
    
    # Docker Repository hinzufügen
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # Docker 29 installieren
    apt-get update
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    
    # Workaround: Min-API-Version auf 1.24 setzen für Portainer-Kompatibilität
    echo -e "${YELLOW}[INFO] Konfiguriere Docker für Portainer-Kompatibilität...${NC}"
    
    # Daemon.json erstellen/aktualisieren
    mkdir -p /etc/docker
    if [ -f /etc/docker/daemon.json ]; then
        # Backup erstellen
        cp /etc/docker/daemon.json /etc/docker/daemon.json.backup
        echo -e "${YELLOW}[INFO] Backup von daemon.json erstellt${NC}"
    fi
    
    # Min-API-Version setzen
    cat > /etc/docker/daemon.json <<EOF
{
  "min-api-version": "1.24"
}
EOF
    
    # Docker Dienst neu starten
    systemctl daemon-reload
    systemctl restart docker
    systemctl enable docker
    
    echo -e "${GREEN}[SUCCESS] Docker 29 erfolgreich installiert mit Portainer-Kompatibilität!${NC}"
    echo -e "${YELLOW}[INFO] Min-API-Version auf 1.24 gesetzt für Portainer${NC}"
    docker --version
}

# Funktion: Docker Compose installieren
install_docker_compose() {
    echo -e "${GREEN}[INFO] Docker Compose ist bereits als Plugin installiert!${NC}"
    docker compose version
}

# Funktion: Portainer Agent installieren
install_portainer_agent() {
    echo -e "${GREEN}[INFO] Installiere Portainer Agent...${NC}"
    
    # Prüfen ob Docker läuft
    if ! systemctl is-active --quiet docker; then
        echo -e "${RED}[ERROR] Docker ist nicht aktiv. Bitte zuerst Docker installieren!${NC}"
        return 1
    fi
    
    # Portainer Agent Container starten
    docker run -d \
      -p 9001:9001 \
      --name portainer_agent \
      --restart=always \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -v /var/lib/docker/volumes:/var/lib/docker/volumes \
      portainer/agent:latest
    
    echo -e "${GREEN}[SUCCESS] Portainer Agent erfolgreich installiert!${NC}"
    echo -e "${YELLOW}[INFO] Portainer Agent läuft auf Port 9001${NC}"
    echo -e "${YELLOW}[INFO] Der Agent funktioniert problemlos mit Docker 29!${NC}"
}

# Funktion: Alles updaten
update_all() {
    echo -e "${GREEN}[INFO] Update aller Komponenten...${NC}"
    
    # System Update
    apt-get update
    apt-get upgrade -y
    
    # Prüfen ob Docker auf hold ist
    if apt-mark showhold | grep -q docker-ce; then
        echo -e "${YELLOW}[INFO] Docker ist auf hold und wird NICHT aktualisiert${NC}"
        echo -e "${YELLOW}[INFO] Um Docker zu aktualisieren, führen Sie aus:${NC}"
        echo -e "${YELLOW}      sudo apt-mark unhold docker-ce docker-ce-cli${NC}"
        echo -e "${YELLOW}      sudo apt-get install -y docker-ce docker-ce-cli${NC}"
    else
        # Docker Update
        if command -v docker &> /dev/null; then
            echo -e "${GREEN}[INFO] Update Docker...${NC}"
            apt-get install -y --only-upgrade docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        fi
    fi
    
    # Portainer Agent Update
    if docker ps -a | grep -q portainer_agent; then
        echo -e "${GREEN}[INFO] Update Portainer Agent...${NC}"
        docker stop portainer_agent
        docker rm portainer_agent
        install_portainer_agent
    fi
    
    echo -e "${GREEN}[SUCCESS] Alle Komponenten wurden aktualisiert!${NC}"
}

# Funktion: Alles deinstallieren
uninstall_all() {
    echo -e "${RED}[WARNUNG] Diese Aktion wird Docker, Docker Compose und Portainer Agent entfernen!${NC}"
    read -p "Möchten Sie wirklich fortfahren? (ja/nein): " confirm
    
    if [ "$confirm" != "ja" ]; then
        echo -e "${YELLOW}[INFO] Deinstallation abgebrochen.${NC}"
        return
    fi
    
    # Hold entfernen falls gesetzt
    apt-mark unhold docker-ce docker-ce-cli 2>/dev/null
    
    # Portainer Agent entfernen
    if docker ps -a | grep -q portainer_agent; then
        echo -e "${GREEN}[INFO] Entferne Portainer Agent...${NC}"
        docker stop portainer_agent
        docker rm portainer_agent
        docker rmi portainer/agent:latest
    fi
    
    # Docker entfernen
    echo -e "${GREEN}[INFO] Entferne Docker...${NC}"
    apt-get purge -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    rm -rf /var/lib/docker
    rm -rf /var/lib/containerd
    rm /etc/apt/sources.list.d/docker.list
    rm /etc/apt/keyrings/docker.gpg
    rm /etc/docker/daemon.json 2>/dev/null
    rm /etc/docker/daemon.json.backup 2>/dev/null
    
    echo -e "${GREEN}[SUCCESS] Alle Komponenten wurden entfernt!${NC}"
}

# Funktion: Docker Version wechseln
switch_docker_version() {
    echo ""
    echo -e "${BLUE}=== Docker Version wechseln ===${NC}"
    echo -e "${YELLOW}Aktuelle Version:${NC}"
    docker --version 2>/dev/null || echo "Docker ist nicht installiert"
    echo ""
    echo "1) Zu Docker 28.x wechseln (stabil, empfohlen)"
    echo "2) Zu Docker 29.x wechseln (neueste, mit Workaround)"
    echo "3) Zurück zum Hauptmenü"
    echo ""
    read -p "Ihre Auswahl [1-3]: " version_choice
    
    case $version_choice in
        1)
            # Hold entfernen falls gesetzt
            apt-mark unhold docker-ce docker-ce-cli 2>/dev/null
            install_docker_28
            ;;
        2)
            # Hold entfernen falls gesetzt
            apt-mark unhold docker-ce docker-ce-cli 2>/dev/null
            install_docker_29
            ;;
        3)
            return
            ;;
        *)
            echo -e "${RED}[ERROR] Ungültige Auswahl!${NC}"
            switch_docker_version
            ;;
    esac
}

# Funktion: Installationsmenü
installation_menu() {
    echo ""
    echo -e "${BLUE}=== Installationsoptionen ===${NC}"
    echo -e "${YELLOW}Welche Docker-Version möchten Sie installieren?${NC}"
    echo ""
    echo "1) Docker 28.x + Portainer Agent (EMPFOHLEN - stabil)"
    echo "2) Docker 29.x + Portainer Agent (neueste, mit Workaround)"
    echo "3) Nur Portainer Agent (Docker muss bereits installiert sein)"
    echo "4) Zurück zum Hauptmenü"
    echo ""
    read -p "Ihre Auswahl [1-4]: " install_choice
    
    case $install_choice in
        1)
            install_docker_28
            install_docker_compose
            install_portainer_agent
            echo ""
            echo -e "${GREEN}╔══════════════════════════════════════════════════════════╗${NC}"
            echo -e "${GREEN}║  Installation abgeschlossen!                             ║${NC}"
            echo -e "${GREEN}╚══════════════════════════════════════════════════════════╝${NC}"
            echo -e "${YELLOW}[INFO] Docker 28.x ist installiert und funktioniert perfekt mit Portainer${NC}"
            echo -e "${YELLOW}[INFO] Docker wird NICHT automatisch aktualisiert (auf hold)${NC}"
            ;;
        2)
            install_docker_29
            install_docker_compose
            install_portainer_agent
            echo ""
            echo -e "${GREEN}╔══════════════════════════════════════════════════════════╗${NC}"
            echo -e "${GREEN}║  Installation abgeschlossen!                             ║${NC}"
            echo -e "${GREEN}╚══════════════════════════════════════════════════════════╝${NC}"
            echo -e "${YELLOW}[INFO] Docker 29.x mit Portainer-Kompatibilität installiert${NC}"
            echo -e "${YELLOW}[INFO] Min-API-Version wurde auf 1.24 gesetzt${NC}"
            ;;
        3)
            install_portainer_agent
            ;;
        4)
            return
            ;;
        *)
            echo -e "${RED}[ERROR] Ungültige Auswahl!${NC}"
            installation_menu
            ;;
    esac
}

# Hauptmenü
main_menu() {
    while true; do
        echo ""
        echo -e "${BLUE}=== Hauptmenü ===${NC}"
        echo "1) Installation"
        echo "2) Docker Version wechseln"
        echo "3) Update (alles aktualisieren)"
        echo "4) Deinstallation (alles entfernen)"
        echo "5) Beenden"
        echo ""
        read -p "Ihre Auswahl [1-5]: " choice
        
        case $choice in
            1)
                installation_menu
                ;;
            2)
                switch_docker_version
                ;;
            3)
                update_all
                ;;
            4)
                uninstall_all
                ;;
            5)
                echo -e "${GREEN}[INFO] Script wird beendet. Auf Wiedersehen!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}[ERROR] Ungültige Auswahl! Bitte wählen Sie 1-5.${NC}"
                ;;
        esac
    done
}

# Script starten
main_menu
